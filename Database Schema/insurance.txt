-- Table: insurance.insurance_company

-- DROP TABLE IF EXISTS insurance.insurance_company;

CREATE TABLE IF NOT EXISTS insurance.insurance_company
(
    insurance_company_id bigint NOT NULL DEFAULT nextval('insurance.insurance_company_insurance_company_id_seq'::regclass),
    company_name character varying(150) COLLATE pg_catalog."default" NOT NULL,
    contact_phone character varying(15) COLLATE pg_catalog."default",
    contact_email character varying(150) COLLATE pg_catalog."default",
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT insurance_company_pkey PRIMARY KEY (insurance_company_id),
    CONSTRAINT uq_insurance_company_name UNIQUE (company_name)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS insurance.insurance_company
    OWNER to postgres;



-- Table: insurance.policy

-- DROP TABLE IF EXISTS insurance.policy;

CREATE TABLE IF NOT EXISTS insurance.policy
(
    policy_id bigint NOT NULL DEFAULT nextval('insurance.policy_policy_id_seq'::regclass),
    vehicle_sale_id bigint NOT NULL,
    chassis_no character varying(50) COLLATE pg_catalog."default" NOT NULL,
    insurance_company_id bigint NOT NULL,
    policy_number character varying(100) COLLATE pg_catalog."default" NOT NULL,
    policy_start_date date NOT NULL,
    policy_end_date date NOT NULL,
    premium_amount numeric(12,2),
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT policy_pkey PRIMARY KEY (policy_id),
    CONSTRAINT uq_policy_number UNIQUE (policy_number),
    CONSTRAINT fk_policy_insurer FOREIGN KEY (insurance_company_id)
        REFERENCES insurance.insurance_company (insurance_company_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE RESTRICT,
    CONSTRAINT fk_policy_sale FOREIGN KEY (vehicle_sale_id)
        REFERENCES sales.vehicle_sale (vehicle_sale_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE RESTRICT,
    CONSTRAINT fk_policy_vehicle FOREIGN KEY (chassis_no)
        REFERENCES master.vehicle (chassis_no) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE RESTRICT
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS insurance.policy
    OWNER to postgres;
-- Index: uq_active_policy_per_vehicle

-- DROP INDEX IF EXISTS insurance.uq_active_policy_per_vehicle;

CREATE UNIQUE INDEX IF NOT EXISTS uq_active_policy_per_vehicle
    ON insurance.policy USING btree
    (chassis_no COLLATE pg_catalog."default" ASC NULLS LAST)
    WITH (fillfactor=100, deduplicate_items=True)
    TABLESPACE pg_default
    WHERE is_active = true;